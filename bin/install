#!/bin/bash

if [ $(id -u) != 0 ]; then
   echo "This script requires root permissions"
   sudo "$0" "$@"
   exit
fi

# https://github.com/pjos/openshift-wiki/wiki
MINISHIFT_VER=1.0.0-beta.4
DM_VER=v0.10.0
DM_KVM_VER=v0.8.2
OC_URL="https://github.com/openshift/origin/releases/download/v1.5.0-rc.0/openshift-origin-client-tools-v1.5.0-rc.0-49a4a7a-linux-64bit.tar.gz"
OC_DIR=$(echo `basename $OC_URL` | sed s,.tar.gz,,)

echo 
echo "*** Insatlling yum components ***"
echo

yum -y update
yum -y groups install "GNOME Desktop"
yum -y install epel-release git docker
systemctl set-default graphical.target
systemctl enable docker

echo 
echo "*** Downloading minishift (/usr/local/bin/minishift) ***"
echo 

wget -qO- https://github.com/minishift/minishift/releases/download/v$MINISHIFT_VER/minishift-$MINISHIFT_VER-linux-amd64.tgz | tar zxf - -C /usr/local/bin minishift
chown root:root /usr/local/bin/minishift
chmod +x /usr/local/bin/minishift

echo 
echo "*** Downloading OpenShift Origin Client (/usr/local/docker-mashine) ***"
echo 

curl -L https://github.com/docker/machine/releases/download/$DM_VER/docker-machine-`uname -s`-`uname -m` > /usr/local/bin/docker-machine && \
chmod +x /usr/local/bin/docker-machine

echo 
echo "*** Downloading OpenShift Origin Client (/usr/local/bin/docker-machine-driver-kvm) ***"
echo 

curl -L https://github.com/dhiltgen/docker-machine-kvm/releases/download/$DM_KVM_VER/docker-machine-driver-kvm > /usr/local/bin/docker-machine-driver-kvm && \
chmod +x /usr/local/bin/docker-machine-driver-kvm

echo 
echo "*** Downloading OpenShift Origin Client (/usr/local/bin/oc) ***"
echo 

# Download OC client
wget -qO- $OC_URL | tar zxvf - -C /tmp $OC_DIR/oc
mv -f /tmp/$OC_DIR/oc /usr/local/bin
chmod +x /usr/local/bin/oc
chown root:root /usr/local/bin/oc
rmdir /tmp/$OC_DIR

# Allow minishift to spin up a VM without anoing authorization questions
# https://superuser.com/questions/548433/how-do-i-prevent-virt-manager-from-asking-for-the-root-password
cat > /etc/polkit-1/rules.d/10.virt.rules <<EOF
polkit.addRule(function(action, subject) {
    if (action.id == "org.libvirt.unix.manage"
            && subject.local
            && subject.active
            && subject.isInGroup("libvirt")) {
        return polkit.Result.YES;
    }
});
EOF

systemctl restart polkit
usermod -a -G libvirt $SUDO_USER 


echo 
echo "*** DONE ***"
echo "minishift start --cpus 2 --memory 8192 --openshift-version=v1.5.0-rc.0"
echo 



